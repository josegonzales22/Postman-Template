<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargando Reporte de Pruebas...</title>
    <style>
        body { 
            font-family: sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            background-color: #f4f4f9; 
        }
        .loader { text-align: center; }
        .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            border-left-color: #09f; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 10px; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p id="status">Buscando el último reporte de ejecución...</p>
    </div>

    <script>
        const USER = "josegonzales22";
        const REPO = "Postman-Template";
        const FOLDER = "reports";

        // Regex para timestamps con formato YYYYMMDD_HHMMSS
        const TIMESTAMP_REGEX = /(\d{8}_\d{6})/;

        function parseTimestamp(name) {
            const match = name.match(TIMESTAMP_REGEX);
            if (!match) return null;

            const raw = match[1]; // "20250205_154012"
            const datePart = raw.split("_")[0];
            const timePart = raw.split("_")[1];

            const year = datePart.substring(0, 4);
            const month = datePart.substring(4, 6);
            const day = datePart.substring(6, 8);

            const hour = timePart.substring(0, 2);
            const min = timePart.substring(2, 4);
            const sec = timePart.substring(4, 6);

            // Convertir a fecha real
            return new Date(`${year}-${month}-${day}T${hour}:${min}:${sec}`);
        }

        async function buscarUltimoReporte() {
            const statusText = document.getElementById("status");

            try {
                const response = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FOLDER}`);

                if (!response.ok) throw new Error("No se pudo acceder a la carpeta de reportes.");

                const files = await response.json();

                const htmlFiles = files.filter(file => file.name.endsWith(".html"));

                if (htmlFiles.length === 0) {
                    statusText.innerText = "No hay archivos HTML en la carpeta.";
                    return;
                }

                // Buscar los que tengan timestamp
                const conTimestamp = htmlFiles
                    .map(file => ({
                        ...file,
                        timestamp: parseTimestamp(file.name)
                    }))
                    .filter(f => f.timestamp !== null);

                let elegido = null;

                if (conTimestamp.length > 0) {
                    // Ordenar por fecha descendente
                    conTimestamp.sort((a, b) => b.timestamp - a.timestamp);
                    elegido = conTimestamp[0];
                    statusText.innerText = "Reporte con timestamp encontrado. Redirigiendo...";
                } else {
                    // fallback: primer html disponible (orden alfabético natural)
                    htmlFiles.sort((a, b) => a.name.localeCompare(b.name));
                    elegido = htmlFiles[0];
                    statusText.innerText = "Sin timestamps. Redirigiendo al primer HTML disponible...";
                }

                window.location.href = elegido.path;

            } catch (error) {
                console.error(error);
                statusText.innerHTML = `Error: ${error.message}<br><small>Verifica que el repo sea público y el nombre de la carpeta sea correcto.</small>`;
            }
        }

        buscarUltimoReporte();
    </script>
</body>
</html>
